<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Monthly Budget Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        .input-box {
            @apply p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full transition duration-150 ease-in-out;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-medium shadow-md transition duration-200 ease-in-out transform hover:scale-[1.02];
        }
        .primary-btn {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        .secondary-btn {
            @apply bg-white text-gray-700 border border-gray-300 hover:bg-gray-100;
        }
    </style>
</head>
<body>

    <!-- Firebase Imports and Initial Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection, query, limit, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level
        // setLogLevel('Debug');

        // Global Firebase and App Variables (Mandatory Canvas Variables)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let budgetData = {
            monthId: '',
            incomes: [],
            expenses: []
        };
        let chartInstance = null;
        let historicalChartInstance = null; // New instance for trend chart
        let monthlySavingsTrend = []; // To store historical data
        
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth(); // 0-indexed

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- CORE FIREBASE FUNCTIONS ---

        const getBudgetDocRef = (monthId) => {
            if (!db || !userId) return null;
            // Private path: /artifacts/{appId}/users/{userId}/budgets/{monthId}
            return doc(db, 'artifacts', appId, 'users', userId, 'budgets', monthId);
        };

        const generateMonthId = (year, month) => {
            return `${year}-${String(month + 1).padStart(2, '0')}`;
        };

        const updateMonthDisplay = () => {
            const display = document.getElementById('month-display');
            if (display) {
                display.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            }
        };

        // Save data to Firestore (Debounced to prevent excessive writes)
        let saveTimeout;
        const saveBudget = () => {
            if (!db || !userId || !budgetData.monthId) {
                console.error("Firestore not ready or monthId missing.");
                return;
            }

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    const docRef = getBudgetDocRef(budgetData.monthId);
                    await setDoc(docRef, budgetData, { merge: true });
                    console.log("Budget saved successfully for:", budgetData.monthId);
                    // Rerun historical load to include the new/updated month
                    loadHistoricalTrendData(); 
                } catch (e) {
                    console.error("Error saving budget:", e);
                    displayMessage(`Error saving budget: ${e.message}`, 'error');
                }
            }, 500); // Wait 500ms after last change
        };

        // Load historical savings data for the trend chart
        const loadHistoricalTrendData = async () => {
            if (!db || !userId) return;

            try {
                // Collection path: /artifacts/{appId}/users/{userId}/budgets
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'budgets');
                
                // Query all documents, ordering by monthId (YYYY-MM) to ensure chronological order
                const q = query(collectionRef, orderBy('monthId'));
                
                const querySnapshot = await getDocs(q);
                
                const historicalData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.monthId && data.incomes && data.expenses) {
                        
                        // Calculate actual income and expenses from the historical document
                        const actualIncome = data.incomes.reduce((sum, item) => sum + (item.actual || 0), 0);
                        const actualExpenses = data.expenses.reduce((sum, item) => sum + (item.actual || 0), 0);

                        // Only track actual savings for the trend chart
                        const actualSavings = actualIncome - actualExpenses;
                        
                        historicalData.push({
                            monthId: data.monthId,
                            actualSavings: actualSavings
                        });
                    }
                });

                // Update the global state and re-render the historical chart
                monthlySavingsTrend = historicalData;
                updateHistoricalChart();
                
            } catch (e) {
                console.error("Error loading historical data:", e);
            }
        };


        // Load data from Firestore and set up real-time listener
        const loadBudget = () => {
            if (!db || !userId) return;

            const monthId = generateMonthId(currentYear, currentMonth);
            budgetData.monthId = monthId;
            updateMonthDisplay();

            const docRef = getBudgetDocRef(monthId);

            // Listen for real-time updates
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Update the local data with the latest from Firestore
                    const loadedData = docSnap.data();
                    budgetData = {
                        ...loadedData,
                        incomes: loadedData.incomes || [],
                        expenses: loadedData.expenses || []
                    };
                    console.log("Budget loaded/updated in real-time:", budgetData);
                } else {
                    // Initialize with defaults if document doesn't exist
                    console.log("No data found, initializing default structure for", monthId);
                    // This check is overly complex since we reload budgetData, but for completeness:
                    // If budgetData is empty (which it is on initial load if no Firestore data exists)
                    if (budgetData.incomes.length === 0) {
                         budgetData.incomes = [
                            { id: crypto.randomUUID(), name: 'Adult 1 Salary', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'Adult 2 Salary', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'Bonus/Extra Income 1', planned: 0, actual: 0 }
                        ];
                    }
                    if (budgetData.expenses.length === 0) {
                        budgetData.expenses = [
                            { id: crypto.randomUUID(), name: 'Mortgage/Rent', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'Insurance (Health/Life/Car)', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'Groceries/Food', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'School Tuition', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'Kid Activities', planned: 0, actual: 0 },
                            { id: crypto.randomUUID(), name: 'Toys/Gifts', planned: 0, actual: 0 },
                        ];
                    }
                    saveBudget(); // Save the initialized structure
                }
                renderApp();
            }, (error) => {
                console.error("Error setting up onSnapshot:", error);
                displayMessage(`Error loading budget: ${error.message}`, 'error');
            });
        };

        // --- AUTHENTICATION & INITIALIZATION ---

        const initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                displayMessage("Firebase configuration error.", 'error');
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const authReadyPromise = new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                        // Updated display text to just "Hello!"
                        document.getElementById('user-id-display').textContent = `Hello!`;
                        resolve();
                    });
                });

                await authReadyPromise;
                loadBudget();
                loadHistoricalTrendData(); // Load historical data on startup

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayMessage(`Initialization failed: ${e.message}`, 'error');
            }
        };

        // --- UI & RENDERING FUNCTIONS ---

        const displayMessage = (message, type = 'info') => {
            const container = document.getElementById('message-container');
            if (container) {
                const color = type === 'error' ? 'bg-red-500' : 'bg-green-500';
                container.innerHTML = `<div class="p-3 text-white rounded-lg shadow-lg ${color}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 5000);
            }
        };

        const renderTableRows = (type) => {
            const dataArray = type === 'income' ? budgetData.incomes : budgetData.expenses;
            const container = document.getElementById(`${type}-rows`);
            if (!container) return;

            container.innerHTML = dataArray.map((item, index) => `
                <tr data-id="${item.id}" class="hover:bg-gray-50">
                    <td class="p-3 border-t">
                        <input
                            type="text"
                            value="${item.name}"
                            class="input-box bg-white font-medium"
                            onchange="handleNameChange('${type}', '${item.id}', this.value)"
                        />
                    </td>
                    <td class="p-3 border-t">
                        <input
                            type="number"
                            value="${item.planned}"
                            min="0"
                            class="input-box text-right"
                            oninput="handleValueChange('${type}', '${item.id}', 'planned', this.value)"
                        />
                    </td>
                    <td class="p-3 border-t">
                        <input
                            type="number"
                            value="${item.actual}"
                            min="0"
                            class="input-box text-right"
                            oninput="handleValueChange('${type}', '${item.id}', 'actual', this.value)"
                        />
                    </td>
                    <td class="p-3 border-t font-semibold text-right">
                        ${(item.actual - item.planned).toFixed(2)}
                    </td>
                    <td class="p-3 border-t text-center">
                        <button onclick="removeItem('${type}', '${item.id}')" class="text-red-500 hover:text-red-700 transition">
                            <!-- SVG Trash Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.5H2.75a.75.75 0 0 0 0 1.5h14.5a.75.75 0 0 0 0-1.5H14.5v-.5A2.75 2.75 0 0 0 11.75 1h-3.5ZM4.68 8.25a.75.75 0 0 1 .785-.644l.872.232 1.353 9.471a.75.75 0 0 1-.785.864l-.916-.135a.75.75 0 0 1-.689-.806l1.3-9.124Zm10.638-1.597a.75.75 0 1 1 1.488.24l-1.4 8.75a.75.75 0 1 1-1.488-.24l1.4-8.75Zm-5.322 0a.75.75 0 1 1 1.488.24l-1.35 9.45a.75.75 0 0 1-1.488-.24l1.35-9.45Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        const calculateTotals = () => {
            const total = (arr) => arr.reduce((sum, item) => sum + (item.planned || 0), 0);
            const totalActual = (arr) => arr.reduce((sum, item) => sum + (item.actual || 0), 0);

            const plannedIncome = total(budgetData.incomes);
            const actualIncome = totalActual(budgetData.incomes);
            const plannedExpenses = total(budgetData.expenses);
            const actualExpenses = totalActual(budgetData.expenses);

            const plannedSavings = plannedIncome - plannedExpenses;
            const actualSavings = actualIncome - actualExpenses;

            return {
                plannedIncome, actualIncome, plannedExpenses, actualExpenses,
                plannedSavings, actualSavings
            };
        };

        const renderSummary = (totals) => {
            const container = document.getElementById('summary-table');
            if (!container) return;

            const varianceIncome = totals.actualIncome - totals.plannedIncome;
            const varianceExpenses = totals.actualExpenses - totals.plannedExpenses;
            const varianceSavings = totals.actualSavings - totals.plannedSavings;

            const getVarianceClass = (value, type) => {
                if (type === 'income') return value >= 0 ? 'text-green-600' : 'text-red-600';
                if (type === 'expense') return value <= 0 ? 'text-green-600' : 'text-red-600';
                if (type === 'savings') return value >= 0 ? 'text-green-600' : 'text-red-600';
                return 'text-gray-700';
            };

            container.innerHTML = `
                <tr class="bg-white hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium border-t">Total Income</td>
                    <td class="px-4 py-2 border-t text-right">$${totals.plannedIncome.toFixed(2)}</td>
                    <td class="px-4 py-2 border-t text-right">$${totals.actualIncome.toFixed(2)}</td>
                    <td class="px-4 py-2 border-t text-right font-semibold ${getVarianceClass(varianceIncome, 'income')}">$${varianceIncome.toFixed(2)}</td>
                </tr>
                <tr class="bg-white hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium border-t">Total Expenses</td>
                    <td class="px-4 py-2 border-t text-right">$${totals.plannedExpenses.toFixed(2)}</td>
                    <td class="px-4 py-2 border-t text-right">$${totals.actualExpenses.toFixed(2)}</td>
                    <td class="px-4 py-2 border-t text-right font-semibold ${getVarianceClass(varianceExpenses, 'expense')}">$${varianceExpenses.toFixed(2)}</td>
                </tr>
                <tr class="bg-indigo-100 font-bold">
                    <td class="px-4 py-3 border-t-2 border-indigo-300">Net Savings/Deficit</td>
                    <td class="px-4 py-3 border-t-2 border-indigo-300 text-right">$${totals.plannedSavings.toFixed(2)}</td>
                    <td class="px-4 py-3 border-t-2 border-indigo-300 text-right">$${totals.actualSavings.toFixed(2)}</td>
                    <td class="px-4 py-3 border-t-2 border-indigo-300 text-right ${getVarianceClass(varianceSavings, 'savings')}">$${varianceSavings.toFixed(2)}</td>
                </tr>
            `;
        };

        const updateChart = (totals) => {
            const expenseLabels = budgetData.expenses.map(e => e.name);
            const expenseActuals = budgetData.expenses.map(e => e.actual);

            // Calculate the total actual expenses for percentage
            const totalActualExpenses = totals.actualExpenses;

            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('budgetChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar', // Using bar chart for main view
                data: {
                    labels: ['Income', 'Expenses', 'Net Savings'],
                    datasets: [
                        {
                            label: `Actual (${budgetData.monthId})`,
                            data: [totals.actualIncome, totals.actualExpenses, totals.actualSavings],
                            backgroundColor: ['#10b981', '#ef4444', totals.actualSavings >= 0 ? '#4f46e5' : '#f97316'], // green, red, indigo/orange
                            borderColor: 'white',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Monthly Financial Snapshot (Actual)',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Expense Breakdown Pie Chart
            const pieCtx = document.getElementById('expensePieChart').getContext('2d');
            if (window.expensePieChartInstance) window.expensePieChartInstance.destroy();

            window.expensePieChartInstance = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: expenseLabels,
                    datasets: [{
                        label: 'Actual Spending Share',
                        data: expenseActuals,
                        backgroundColor: [
                            '#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#6366f1',
                            '#fb923c', '#d946ef', '#14b8a6', '#f43f5e'
                        ],
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: {
                            display: true,
                            text: 'Expense Breakdown (Actual Spending)',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    // Avoid division by zero
                                    const percentage = totalActualExpenses > 0 ? (value / totalActualExpenses * 100).toFixed(1) : 0;
                                    return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };

        const updateHistoricalChart = () => {
            const labels = monthlySavingsTrend.map(d => {
                // Format YYYY-MM to MM/YYYY for chart readability
                const parts = d.monthId.split('-');
                return `${parts[1]}/${parts[0]}`;
            });
            const data = monthlySavingsTrend.map(d => d.actualSavings);

            const ctx = document.getElementById('savingsTrendChart').getContext('2d');
            if (historicalChartInstance) historicalChartInstance.destroy();

            historicalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Actual Net Savings ($)',
                        data: data,
                        borderColor: '#4f46e5', // Indigo
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        // Color points: Green for positive savings, Red for deficit
                        pointBackgroundColor: data.map(val => val >= 0 ? '#10b981' : '#ef4444')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Month-to-Month Savings/Deficit Trend',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: $${value.toFixed(2)} (${value >= 0 ? 'Savings' : 'Deficit'})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            // Do not force beginAtZero, as trend lines should reflect relative changes
                            beginAtZero: false, 
                            grid: { color: '#e5e7eb' },
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        };


        const renderApp = () => {
            const totals = calculateTotals();
            renderTableRows('income');
            renderTableRows('expense');
            renderSummary(totals);
            updateChart(totals);
            // updateHistoricalChart is called after loadHistoricalTrendData completes
        };

        // --- HANDLERS (EXPOSED TO GLOBAL SCOPE FOR HTML ACCESS) ---

        window.handleValueChange = (type, id, field, value) => {
            const arr = type === 'income' ? budgetData.incomes : budgetData.expenses;
            const item = arr.find(i => i.id === id);
            if (item) {
                // Ensure value is treated as a number
                item[field] = parseFloat(value) || 0;
            }
            renderApp(); // Rerender to show immediate calculation updates
            saveBudget();
        };

        window.handleNameChange = (type, id, name) => {
            const arr = type === 'income' ? budgetData.incomes : budgetData.expenses;
            const item = arr.find(i => i.id === id);
            if (item) {
                item.name = name;
            }
            renderApp(); // Rerender to update chart labels
            saveBudget();
        };

        window.addItem = (type) => {
            const newItem = {
                id: crypto.randomUUID(),
                name: type === 'income' ? 'New Income Stream' : 'New Category',
                planned: 0,
                actual: 0
            };
            if (type === 'income') {
                budgetData.incomes.push(newItem);
            } else {
                budgetData.expenses.push(newItem);
            }
            renderApp();
            saveBudget();
        };

        window.removeItem = (type, id) => {
            if (type === 'income') {
                budgetData.incomes = budgetData.incomes.filter(i => i.id !== id);
            } else {
                budgetData.expenses = budgetData.expenses.filter(i => i.id !== id);
            }
            renderApp();
            saveBudget();
        };

        window.changeMonth = (delta) => {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadBudget(); // Reload data for the new month
        };

        // Initialize on window load
        window.onload = initFirebase;
    </script>

    <!-- Main Application UI -->
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">Family Budget Hub</h1>
            <p class="text-gray-500 mt-1" id="user-id-display">Initializing...</p>
        </header>

        <!-- Message Container for Feedback -->
        <div id="message-container" class="fixed top-4 right-4 z-50"></div>

        <!-- Month Navigation -->
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-8">
            <button onclick="changeMonth(-1)" class="secondary-btn text-indigo-600 border-indigo-300">
                &larr; Previous Month
            </button>
            <h2 id="month-display" class="text-3xl font-bold text-gray-800">Month/Year</h2>
            <button onclick="changeMonth(1)" class="secondary-btn text-indigo-600 border-indigo-300">
                Next Month &rarr;
            </button>
        </div>

        <!-- Budget Summary Table -->
        <section class="mb-10">
            <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Monthly Financial Overview</h3>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Metric</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-indigo-700 uppercase tracking-wider">Planned ($)</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-indigo-700 uppercase tracking-wider">Actual ($)</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-indigo-700 uppercase tracking-wider">Variance (Actual - Planned)</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table" class="divide-y divide-gray-200">
                        <!-- Summary rows rendered here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Income and Expense Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">

            <!-- Income Section -->
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-green-700">Income Streams</h3>
                    <button onclick="addItem('income')" class="btn primary-btn bg-green-500 hover:bg-green-600 text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                        Add Income
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Source</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Planned ($)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Actual ($)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Variance</th>
                                <th class="px-3 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="income-rows" class="bg-white divide-y divide-gray-100">
                            <!-- Income rows rendered here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Expense Section -->
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-red-700">Expense Categories</h3>
                    <button onclick="addItem('expense')" class="btn primary-btn bg-red-500 hover:bg-red-600 text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                        Add Expense
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Category</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Planned ($)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Actual ($)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Variance</th>
                                <th class="px-3 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-rows" class="bg-white divide-y divide-gray-100">
                            <!-- Expense rows rendered here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Charts Section -->
        <section class="mb-10">
            <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Visual Budget Analysis</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Bar Chart: Savings vs. Expenses -->
                <div class="bg-white p-6 rounded-xl shadow-lg h-[400px]">
                    <canvas id="budgetChart"></canvas>
                </div>

                <!-- Doughnut Chart: Expense Breakdown -->
                <div class="bg-white p-6 rounded-xl shadow-lg h-[400px]">
                    <canvas id="expensePieChart"></canvas>
                </div>
            </div>
            
            <!-- New Historical Savings Trend Chart -->
            <div class="bg-white p-6 rounded-xl shadow-lg h-[450px]">
                <canvas id="savingsTrendChart"></canvas>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm mt-8 pt-4 border-t">
            Budget data is securely stored and synchronized in real-time using Firestore.
        </footer>
    </div>

</body>
</html>
